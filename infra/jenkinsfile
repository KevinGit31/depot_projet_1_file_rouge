pipeline {
    environment {
        NEXUS_VERSION = "nexus3"
        NEXUS_PROTOCOL = "http"
        NEXUS_URL = "10.80.140.11:8081"
        NEXUS_REPOSITORY = "APP"
        NEXUS_CREDENTIAL_ID = "nexus"
        NEXUS_ARTIFACT_ID = "qcm"
        SECRETDEVOPS_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SECRETDEVOPS', returnStdout: true).trim()}"
        ROOTKEY_ENV = "NONE" //"${env.$ROOTKEY}"
        JENKINS_KEY = "NONE"
        ANSIBLE_KEY = "NONE"
        KEYNAME_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $KEYNAME', returnStdout: true).trim()}"
        REGION1_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $REGION', returnStdout: true).trim()}"
        SUBIDPUB_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPUB', returnStdout: true).trim()}"
        SUBIDPRIV_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPRIV', returnStdout: true).trim()}"
        SUBIDPUBADM_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPUBDEV', returnStdout: true).trim()}"
        SUBIDPRIVDEV_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPRIVDEV', returnStdout: true).trim()}"
        SUBIDPUBQUA_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPUBQUA', returnStdout: true).trim()}"
        SUBIDPRIVQUA_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPRIVQUA', returnStdout: true).trim()}"
        SUBIDPUBPROD_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPUBPROD', returnStdout: true).trim()}"
        SUBIDPRIVPROD_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPRIVPROD', returnStdout: true).trim()}"
        PRIVIP_ENV = "10.80.110.20" //"${env.$PRIVIP}"
        INGRPORT_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $INGRPORT', returnStdout: true).trim()}"
        SECGRPNLST_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SECGRPNLST', returnStdout: true).trim()}"
        USCRIPT_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $USCRIPT', returnStdout: true).trim()}"
        SECGRPID_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SECGRPID', returnStdout: true).trim()}"
        INSTTYPE_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $INSTTYPE', returnStdout: true).trim()}"
        AWSACCESSKEYID = "NONE"
        AWSACCESSSECRETEKEYID = "NONE"
        VPCID_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $VPCID', returnStdout: true).trim()}"

        //VARIABLE A MODIFIER SUIVANT L4ENVIRONNEMENT
        SUBIDPRIVADM_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPRIVDEV', returnStdout: true).trim()}"
        SUBIDPUBDEV_ENV = "${sh(script:'source /var/lib/jenkins/.bashrc && echo $SUBIDPUBDEV', returnStdout: true).trim()}"
        ENVIRONNEMENT = "dev"
        TYPENAME_ENV = "qcmdev" //"${env.$TYPENAME}"
    }
//
agent any
    stages {
        stage('clone source') {
            steps {
                sh 'rm -rf depot_projet_1_file_rouge'
                git branch: 'dev', url: 'https://github.com/KevinGit31/depot_projet_1_file_rouge.git'
            }
        }
//        stage('test'){
//            steps {
//                sh 'sleep 15s'
//                sh 'curl http://192.168.40.11:3002'
//
//            }
//        }
        stage("Build") {
            steps {
                script {
                    sh 'tar cvfz qcm.tar.gz quizz/'
                }
            }
        }
        stage('push nexus') {
            steps{
                nexusArtifactUploader artifacts: [
                    [
                        artifactId: "${NEXUS_ARTIFACT_ID}",
                        classifier: '',
                        file: "qcm.tar.gz",
                        type: 'tar.gz'
                        ]
                    ],
                    credentialsId: "${NEXUS_CREDENTIAL_ID}",
                    groupId: '',
                    nexusUrl: "${NEXUS_URL}",
                    nexusVersion: "${NEXUS_VERSION}",
                    protocol: "${NEXUS_PROTOCOL}",
                    repository: "${NEXUS_REPOSITORY}",
                    version: "1.0-${BUILD_NUMBER}"
            }
        }
//test du build versionnÃ©
        stage('testnexuscible'){
            steps {
                sh 'sleep 15s'
                sh "curl http://${NEXUS_URL}/repository/${NEXUS_REPOSITORY}/${NEXUS_ARTIFACT_ID}/1.0-${BUILD_NUMBER}/${NEXUS_ARTIFACT_ID}-1.0-${BUILD_NUMBER}.tar.gz"
            }
        }
//        stage('ansible'){
//            steps {
//                ansiblePlaybook(
//                playbook: "infra/ansible/${ENVIRONNEMENT}.yml",
//                inventory: "infra/ansible/inventory/${ENVIRONNEMENT}/hosts",
//                vaultCredentialsId: "${ANS_ENV}",
//                extras: "ansible_environnement=dev VpcId=${VPCID_ENV} PrivateIP=${PRIVIP_ENV} secret_devops=${env.SECRETDEVOPS_ENV} ROOTKEY=\"\" KEYNAME=${env.ROOTKEY_ENV} TypeName=${env.TYPENAME_ENV} REGION=${env.REGION1_ENV} SubnetIdPub=${env.SUBIDPUB_ENV} SubnetIdPriv=${env.SUBIDPRIV_ENV} VpcId=${env.VPCID_ENV} PrivateIP=${env.PRIVIP_ENV} IngressPort=${env.INGRPORT_ENV} SecurityGroupNameList=${env.SECGRPNLST_ENV} Urlscript=${env.USCRIPT_ENV} SecurityGroupId=${env.SECGRPID_ENV} InstanceType=${env.INSTTYPE_ENV}"
//                )
//            }
//        }

//        stage('deleteEC2ansible') {
//            steps {
//                    sh """#!/bin/bash
//                    /var/lib/jenkins/.local/bin/ansible-playbook -i infra/ansible/inventory/${ENVIRONNEMENT}/hosts infra/ansible/${ENVIRONNEMENT}.yml --vault-password-file /var/lib/jenkins/ansvlt.sh --extra-vars \"GOTODEL=yes secret_devops=${env.SECRETDEVOPS_ENV} ROOTKEY=${env.ROOTKEY_ENV} KEYNAME=${env.ROOTKEY_ENV} TypeName=${env.TYPENAME_ENV} REGION=${env.REGION1_ENV} SubnetIdPub=${env.SUBIDPUB_ENV} SubnetIdPriv=${env.SUBIDPRIV_ENV} VpcId=${env.VPCID_ENV} PrivateIP=${env.PRIVIP_ENV} IngressPort=${env.INGRPORT_ENV} SecurityGroupNameList=${env.SECGRPNLST_ENV} Urlscript=${env.USCRIPT_ENV} SecurityGroupId=${env.SECGRPID_ENV} InstanceType=${env.INSTTYPE_ENV}\" --tags \"clouddelete\"
//                    """
//            }
//        }
//A FAIRE TEST si EC2 DEL
        stage('createEC2ansible') {
            steps {
                    sh """#!/bin/bash
                    yes | cp -rf infra/aws_cloudorm/instancegrp3.yaml infra/ansible/roles/common/tasks/instancegrp3.yaml
                    echo "TypeName: ${TYPENAME_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "REGION: ${REGION1_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "KEYNAME: ${KEYNAME_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "ansible_environnement: ${ENVIRONNEMENT}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "RootKey: ${ROOTKEY_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "JenkinsKey: ${JENKINS_KEY}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "AnsibleKey: ${ANSIBLE_KEY}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "secret_devops: ${SECRETDEVOPS_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPubADM: ${SUBIDPUBADM_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPrivADM: ${SUBIDPRIVADM_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPubDEV: ${SUBIDPUBDEV_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPrivDEV: ${SUBIDPRIVDEV_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPubQUA: ${SUBIDPUBQUA_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPrivQUA: ${SUBIDPRIVQUA_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPubPROD: ${SUBIDPUBPROD_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SubnetIdPrivPROD: ${SUBIDPRIVPROD_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "VpcId: ${VPCID_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "PrivateIP: ${PRIVIP_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "IngressPort: ${INGRPORT_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SecurityGroupNameList: ${SECGRPNLST_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "Urlscript: ${USCRIPT_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "SecurityGroupId: ${SECGRPID_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "InstanceType: ${INSTTYPE_ENV}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "AWSAccessKeyId: ${AWSACCESSKEYID}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    echo "AWSSecretAccessKeyId: ${AWSACCESSSECRETEKEYID}" >> infra/ansible/inventory/${ENVIRONNEMENT}/group_vars/all/all
                    ansible-playbook -i infra/ansible/inventory/${ENVIRONNEMENT}/hosts infra/ansible/${ENVIRONNEMENT}.yml
                    """
            }

        }

//A FAIRE TEST si EC2 OK
    }
}