- name: Creates directory ~/app
  become_user: devops
  become: true
  file:
    path: ~/app
    state: directory
    owner: devops
    group: devops
    mode: '0766'

- name: Download nexus build
  become_user: devops
  become: true
  get_url:
    url: http://{{ dnsnexus }}:8081/repository/APP/1/qcm/1.0-{{ numbuild }}/qcm-1.0-{{ numbuild }}.tar.gz
    dest: ~/app
    username: "{{ adminnexus }}"
    password: "{{ pwdnexus }}"

- name: Extract ~/app/qcmxxx.tar.gz
  become_user: devops
  become: true
  unarchive:
    src: ~/app/qcm-1.0-{{ numbuild }}.tar.gz
    dest: ~/app
    remote_src: yes

- name: mise a jour du fichier ~/app/quizz/src/config/appconfig.py
  become_user: devops
  become: true
  lineinfile:
    path: ~/app/quizz/src/config/appconfig.py
    regexp: '^(.*)app.config[\'SQLALCHEMY_DATABASE_URI\'] = \'mysql+pymysql://user.quizz:dru98eDFC90@localhost/db.quizz(.*)$\''
    line: '     app.config[\'SQLALCHEMY_DATABASE_URI\'] = \'mysql+pymysql://{{ userdb }}:{{ pwddb }}@{{ dnsdb }}/{{ namedb }}\''
    backrefs: yes

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  become_user: devops
  become: true
  lineinfile:
    path: ~/app/quizz/src/models/app.py
    regexp: '^(.*)# app_config(app)(.*)$'
    line: 'app_config(app)'
    backrefs: yes

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  become_user: devops
  become: true
  lineinfile:
    path: ~/app/quizz/src/models/app.py
    regexp: '^(.*)tsconfig(app)(.*)$'
    line: '#tsconfig(app)'
    backrefs: yes

- name: Creation de la BDD ~/app/quizz/script/create-quizz-db.sh
  become_user: devops
  become: true
  shell: create-quizz-db.sh
  args:
    chdir: ~/app/quizz/script
    executable: /bin/bash

- name: run qcm ~/app/quizz/script/start-quizz.sh
  become_user: devops
  become: true
  shell: start-quizz.sh
  args:
    chdir: ~/app/quizz/script
    executable: /bin/bash

- name: Change file ownership, group and permissions
  become_user: devops
  become: true
  file:
    path: ~/app
    mode: '0644'