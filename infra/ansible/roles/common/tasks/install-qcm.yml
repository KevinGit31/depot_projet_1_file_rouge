- name: Creates directory ~/app
  become_user: devops
  file:
    path: ~/app
    state: directory
    owner: devops
    group: devops
    mode: '0766'

- name: Download nexus build
  become_user: devops
  get_url:
    url: http://{{ dnsnexus }}:8081/repository/APP/1/qcm/1.0-{{ numbuild }}/qcm-1.0-{{ numbuild }}.tar.gz
    dest: ~/app
    username: "{{ adminnexus }}"
    password: "{{ pwdnexus }}"

- name: Extract ~/app/qcmxxx.tar.gz
  become_user: devops
  unarchive:
    src: ~/app/qcm-1.0-{{ numbuild }}.tar.gz
    dest: ~/app
    remote_src: yes

- name: mise a jour du fichier ~/app/quizz/src/config/appconfig.py
  become_user: devops
  lineinfile:
    path: ~/app/quizz/src/config/appconfig.py
    regexp: '^(.*)app\.config\[(.*)$'
    line: "     app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://{{ userdb }}:{{ pwddb }}@{{ dnsdb }}/{{ namedb }}'"
    backrefs: yes

- name: chmod +x des scripts sh
  become_user: devops
  file:
    dest: "{{ item }}"
    mode: a+x
  with_items:
    - ~/app/quizz/script/create-quizz-db.sh
    - ~/app/quizz/script/create-test-db.sh
    - ~/app/quizz/script/start-quizz.sh
    - ~/app/quizz/src/models/models.py
    - ~/app/quizz/src/tests/init_test_db.py
    - ~/app/quizz/src/api/app.py
    - ~/app/quizz/src/tests/test_answer.py
    - ~/app/quizz/script/install-env.sh

- name: Add another bin dir to system-wide $PATH
  become_user: devops
  become: true
  lineinfile:
    dest: /home/devops/.bashrc
    line: 'PATH=$PATH:/home/devops/.local/bin:/usr/local/bin'

- name: Download python3.9
  become_user: devops
  become: true
  get_url:
    url: https://www.python.org/ftp/python/3.9.6/Python-3.9.6.tgz
    dest: ~/Python-3.9.6.tgz

- name: Extract ~/Python-3.9.6.tgz
  become_user: devops
  become: true
  unarchive:
    src: ~/Python-3.9.6.tgz
    dest: ~/
    remote_src: yes

- name: install python3.9
  become_user: devops
  become: true
  shell: "{{ item }}"
  args:
    chdir: ~/Python-3.9.6
    executable: /bin/bash
  with_items:
    - ./configure --enable-optimizations
    - sudo make install
    - rm -f ~/Python-3.9.6.tgz

- name: Create symlink
  file:
    src: /usr/local/bin/python3.9
    dest: /bin/python3
    state: link

# - name: Install pipenv ~/app/quizz/script/install-env.sh
#   become_user: devops
#   become: true
#   shell: install-env.sh
#   args:
#     chdir: /home/devops/app/quizz/script
#     executable: /bin/bash
# - name: Install pipenv
#   become_user: devops
#   shell: ~/.local/bin/pipenv install
#   args:
#     chdir:  ~/app/quizz/src
#     executable: /bin/bash

- name: install pipenv
  become_user: devops
  shell: "{{ item }}"
  args:
    chdir: ~/app/quizz/src
    executable: /bin/bash
  with_items:
    - pip3 install pipenv
    - ~/.local/bin/pipenv install


# - name: Creation de la BDD ~/app/quizz/script/create-test-db.sh
#   become_user: devops
#   become: true
#   shell: create-test-db.sh
#   args:
#     chdir: ~/app/quizz/script
#     executable: /bin/bash

# - name: Creation de la BDD ~/app/quizz/script/create-test-db.sh
#   become_user: devops
#   shell: ~/.local/bin/pipenv run python3 tests/init_test_db.py
#   args:
#     chdir: ~/app/quizz/src
#     executable: /bin/bash

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  become_user: devops
  lineinfile:
    path: ~/app/quizz/src/models/app.py
    regexp: '^# app_config\(app\)(.*)$'
    line: app_config(app)
    backrefs: yes

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  become_user: devops
  lineinfile:
    path: ~/app/quizz/src/models/app.py
    regexp: '^tsconfig\(app\)(.*)$'
    line: '#tsconfig(app)'
    backrefs: yes


# - name: Creation de la BDD ~/app/quizz/script/create-quizz-db.sh
#   become_user: devops
#   shell: ~/.local/bin/pipenv run python3 tests/init_test_db.py
#   args:
#     chdir: ~/app/quizz/src
#     executable: /bin/bash

- name: Creation de la BDD ~/app/quizz/script/create-quizz-db.sh
  become_user: devops
  shell: ~/.local/bin/pipenv run python3 models/models.py
  args:
    chdir: ~/app/quizz/src
    executable: /bin/bash

# - name: run qcm ~/app/quizz/script/start-quizz.sh
#   become_user: devops

#   shell: start-quizz.sh
#   args:
#     chdir: ~/app/quizz/script
#     executable: /bin/bash


- name: run qcm ~/app/quizz/script/start-quizz.sh
  become_user: devops
  shell: ~/.local/bin/pipenv run python3 api/app.py
  args:
    chdir: ~/app/quizz/src
    executable: /bin/bash

- name: Change file ownership, group and permissions
  become_user: devops
  become: true
  file:
    dest: ~/app
    mode: '0644'

