---
#1 modif
#quizz/src/config/appconfig.py modif valeur     app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://user.quizz:dru98eDFC90@localhost/db.quizz'
#2 modif quizz/src/models/app.py décommenté ligne 24 et commenté ligne 25
#3 run quizz/script/create-quizz-db.sh
#4 run quizz/script/start-quizz.sh

- name: Creates directory ~/app
  gather_facts: false
  remote_user: devops
  become: true
  shell: mkdir app
  chdir: ~/
  args:
    executable: /bin/bash

  # gather_facts: false
  # remote_user: devops
  # become: true
  # file:
  #   path: ~/app
  #   state: directory
  #   owner: devops
  #   group: devops
  #   mode: '0655'

- name: DL nexus ~/app
  gather_facts: false
  remote_user: devops
  become: true
  maven_artifact:
    group_id: ""
    artifact_id: qcm
    repository_url: 'http://10.80.140.11:8081/repository/APP/'
    username: "{{ adminnexus }}"
    password: "{{ pwdnexus }}"
    dest: ~/qcm-latest.tar.gz

- name: Extract ~/app/qcmxxx.tar.gz
  gather_facts: false
  remote_user: devops
  become: true
  unarchive:
    src: ~/app/qcm-latest.tar.gz
    dst: ~/app

- name: mise a jour du fichier ~/app/quizz/src/config/appconfig.py
  gather_facts: false
  remote_user: devops
  become: true
  lineinfile:
    dest: ~/app/quizz/src/config/appconfig.py
    regexp: ^     app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://user.quizz:dru98eDFC90@localhost/db.quizz'
    line: "     app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://{{ userdb }}:{{ pwddb }}@{{ dnsdb }}/{{ namedb }}'"

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  gather_facts: false
  remote_user: devops
  become: true
  lineinfile:
    dest: ~/app/quizz/src/models/app.py
    regexp: ^# app_config(app)
    line: "app_config(app)"

- name: mise a jour du fichier ~/app/quizz/src/models/app.py
  gather_facts: false
  remote_user: devops
  become: true
  lineinfile:
    dest: ~/app/quizz/src/models/app.py
    regexp: ^tsconfig(app)
    line: "#tsconfig(app)"

- name: Creation de la BDD ~/app/quizz/script/create-quizz-db.sh
  gather_facts: false
  remote_user: devops
  become: true
  shell: create-quizz-db.sh
  chdir: ~/app/quizz/script/
  args:
    executable: /bin/bash

- name: run qcm ~/app/quizz/script/start-quizz.sh
  gather_facts: false
  remote_user: devops
  become: true
  shell: start-quizz.sh
  chdir: ~/app/quizz/script/
  args:
    executable: /bin/bash